<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <!-- js -->
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/topojson.v1.min.js"></script>
  <script src="https://d3js.org/d3-queue.v3.min.js"></script>

  <!-- Chart styling -->
  <style>
      .tract {
          fill: none;
      }
      .county {
          fill: none;
          stroke: #fff;
          stroke-linejoin: round;
          stroke-width: 1.5;
      }
      .state {
          fill: none;
          stroke: #666;
          stroke-linejoin: round;
      }
      .legend {
          font-family: sans-serif;
          font-size: 11px;
          text-anchor: middle;
      }
  </style>
</head>

<body>
<script>
var width = 960,
    height = 500;

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var path = d3.geoPath()
    .pointRadius(2);

var color = d3.scaleThreshold()
    // Most sensible threshold based on histogram of values
    .domain([2, 4, 6, 8, 10, 12])
    .range(['#ffffb2','#fed976','#feb24c','#fd8d3c','#f03b20','#bd0026']);

d3.json('data/processed/maps/2014-tracts.json', function(data) {

    // Create vars to hold different levels of granulairty
    var tracts = topojson.feature(data, data.objects.tracts),
        counties = topojson.mesh(data, data.objects.tracts, function(a, b) {
            return census(a.id) !== census(b.id);
        });
        iowa = topojson.merge(data, data.objects.tracts.geometries);

    // Set up the projections using the data to set projection scale
    path.projection(d3.geoConicConformal()
        .parallels([42 + 4 / 60, 43 + 16 / 60])
        .rotate([93 + 30 / 60, -41 - 30 / 60])
        .fitSize([width, height], tracts));

    // Census tracts
    svg.selectAll('path')
            .data(tracts.features)
        .enter().append('path')
        .attr('class', 'tract')
        .attr('d', path)
        .style('fill', function(d) { return color(d.properties.hisp_perc); });

    // Counties
    svg.append('path')
        .datum(counties)
        .attr('class', 'county')
        .attr('d', path);

    // State outline
    svg.append('path')
        .datum(iowa)
        .attr('class', 'state')
        .attr('d', path);

    legend();
});

// Retrieve the County from the GEOID as FIPS
function census(tract) {
    var county = tract.substring(0, 5);
    return county;
}

function legend() {
    var g = svg.append('g'),
        legend = g.selectAll('.legend')
            .data(color.domain())
        .enter().append('g')
        .attr('class', 'legend');

    legend.append('rect')
        .attr('x', function(d, i) { return (width / 3) + (i * 60); })
        .attr('y', height - 20)
        .attr('width', 58)
        .attr('height', 10)
        .style('fill', function(d) { console.log(d);return color(d); });

    legend.append('text')
        .attr('x', function(d, i) {
            var temp = i > 0 ? -31 : 31;
            return (width / 3) + (i * 60) + temp; })
        .attr('y', height - 30)
        .text(function(d) { return d + "%"; });

}
</script>
</body>
